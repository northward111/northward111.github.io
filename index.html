<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Home">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Home">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Home">
  
    <link rel="alternate" href="/atom.xml" title="Home" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Home</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-MBA外接显示器后关闭自带显示器" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/MBA外接显示器后关闭自带显示器/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>MacBook Air屏幕太小，外接了一个显示器，感觉好多了，顺带配了外接的键鼠。因此，MBA本身就可以安安静静地一边呆着了，本身我是直接把它的盖子合上放到一边的，不过搜索了一番发现盖子合上之后会影响散热，甚至有的说会直接烘烤屏幕，这问题就大了，但是打开盖子之后，也不能直接设置屏幕只投射到外接显示器上，要么把外接显示器作为主显示器，内置的作为扩展屏幕，要么就是镜像屏幕，都不是我要的效果。</p>
<p>网友的力量是强大的，发现两个解决方案：</p>
<ol>
<li>拿个磁铁放到电源接口附近，让电脑的感应器误以为已经合上盖子了，屏幕自然就熄了；</li>
<li>在mac上调整屏幕亮度到最低，会发现内置显示器亮度调到了最低，基本可以看做熄了，同时外置显示器不受影响。</li>
</ol>
<p>磁铁的方案据说可能对电脑有损伤，所以还是第二个方法比较靠谱，推荐给大家。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/MBA外接显示器后关闭自带显示器/" data-id="cjba9sv3j0008hhs6qqfxki5z" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-AFNetwork信号量转异步请求为同步请求引起死锁问题解决" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/AFNetwork信号量转异步请求为同步请求引起死锁问题解决/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ASIHttpRequest→AFNetwork，同步→异步"><a href="#ASIHttpRequest→AFNetwork，同步→异步" class="headerlink" title="ASIHttpRequest→AFNetwork，同步→异步"></a>ASIHttpRequest→AFNetwork，同步→异步</h1><p>项目上以前是用的ASIHttpRequest，一个典型的网络请求流程（请求新闻数据）如下：<br> 在新闻列表页面中，加载新闻函数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">-(void) fetchNews</div><div class="line">&#123;</div><div class="line">    dispatch_queue_t newsQueue=dispatch_queue_create(&quot;fetchNewsList&quot;,NULL);</div><div class="line">    dispatch_async(newsQueue, ^&#123;</div><div class="line">        NSDictionary *dictNews= [NewsDAO getNews];</div><div class="line">        BOOL bPass =  [[dictNews objectForKey:@&quot;pass&quot;] boolValue];</div><div class="line">        if(bPass)&#123;</div><div class="line">            NSMutableArray *listTemp = (NSMutableArray*) [dictNews objectForKey:@“list”];</div><div class="line">            [self.listNews removeAllObjects];</div><div class="line">            [self.listNews addObjectsFromArray:listTemp];</div><div class="line">        &#125;</div><div class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">            [self.tableView reloadData];</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 页面中直接使用GCD来将加载数据的操作放到后台线程中，NewsDAO的getNews方法为获取新闻数据的方法，该方法以同步请求方式返回新闻数据，内部调用的是ASIHttpRequest的同步方法。<br>后来发现使用AFNetwork来进行网络请求更加方便，AFNetwork推荐使用异步请求方式来进行请求，因此新闻页面中加载新闻的方法修改为如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">-(void) fetchNews</div><div class="line">&#123;</div><div class="line">    [NewsDAO getNewsSuccess:^(NSURLSessionDataTask *task, id  _Nullable responseObject) &#123;</div><div class="line">        NSMutableArray *newsArray=[PINewsBO getNewsListWithResponseObject:responseObject];//将结果转为实体数组</div><div class="line">        [self.listNews removeAllObjects];</div><div class="line">        [self.listNews addObjectsFromArray:newsArray];</div><div class="line">        [self.tableView reloadData];</div><div class="line">    </div><div class="line">    &#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError *error) &#123;</div><div class="line">        NSLog(@&quot;%@&quot;, error);</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法中，NewsDAO的getNews方法为获取新闻的方法，该方法本身是一个异步方法，请求数据后触发回调来更新页面UI。<br>这样的调用方式的好处还是很明显的，突出的好处就是页面中不用再写那么多GCD的代码了，并且AFNetwork是现在主流网络库，更新及时，更加可靠。</p>
<h1 id="同步方法中使用AFNetwork"><a href="#同步方法中使用AFNetwork" class="headerlink" title="同步方法中使用AFNetwork"></a>同步方法中使用AFNetwork</h1><p>但是鉴于现有项目上许多业务页面已经采用了老的写法，将他们全部改过来工作量还是不小的，那么如果希望在不更改现有页面的写法的基础上，将网络请求库更替为AFNetwork呢，也就是说如何在一个同步方法中使用AFNetwork呢？<br>经过一番搜索，得知一个较为可行的方案是采用信号量的方法来在同步方法中使用异步请求的方式，方法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">-(NSString *)sync:(NSString *)urlStr params:(NSString *)params&#123;</div><div class="line">    __block NSString *resultStr=@&quot;&quot;;</div><div class="line">    AFHTTPSessionManager *manager=[AFHTTPSessionManager manager];</div><div class="line">    AFHTTPResponseSerializer *responseSerializer=[AFHTTPResponseSerializer serializer];</div><div class="line">    manager.responseSerializer=responseSerializer;</div><div class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0); //创建信号量</div><div class="line">    [manager POST:urlStr parameters:params progress:nil success:^(NSURLSessionDataTask *task, id responseObject) &#123;</div><div class="line">        if (responseObject) &#123;</div><div class="line">            NSString *responseStr=[[NSString alloc] initWithData:responseObject encoding:NSUTF8StringEncoding];</div><div class="line">            resultStr=responseStr;</div><div class="line">        &#125;</div><div class="line">        dispatch_semaphore_signal(semaphore);//不管请求状态是什么，都得发送信号，否则会一直卡着进程</div><div class="line">    &#125; failure:^(NSURLSessionDataTask *task, NSError *error) &#123;</div><div class="line">        dispatch_semaphore_signal(semaphore);//不管请求状态是什么，都得发送信号，否则会一直卡着进程</div><div class="line">    &#125;];</div><div class="line">    dispatch_semaphore_wait(semaphore,DISPATCH_TIME_FOREVER);  //等待</div><div class="line">    return resultStr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是此方法在实践中遇到了诡异的问题，大多数请求都可以正常请求成功，但是有一部分请求却卡住了，应用直接不能动了，搜索得知是死锁了，在AFNetwork的请求方法的两个回调也就是success和failure回调中分别打上断点，运行程序发现，这两个回调都没有触发，果不其然。<br>上网搜索发现这个帖子<a href="http://www.cocoachina.com/bbs/read.php?tid=1695717" target="_blank" rel="external">http://www.cocoachina.com/bbs/read.php?tid=1695717</a></p>
<blockquote>
<p>如果没有什么特别制定，那么AF的两个回调Block均执行在主线程上。所以你这里实际上是已经死锁了。<br>打个断点你会发现两个Block根本没有办法执行，因为他们都需要等主线程执行完所有任务才会执行，而主线程堵在dispatch_semaphore_wait上了。而释放它的函数写在一个永远无法执行的Block里面。</p>
</blockquote>
<p>后面也给出了解决方案，就是给AFNetwork指定回调函数在子线程中执行就可以了，指定方法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manager.completionQueue=dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div></pre></td></tr></table></figure></p>
<p>修改后的请求方法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">-(NSString *)sync:(NSString *)urlStr params:(NSString *)params&#123;</div><div class="line">    __block NSString *resultStr=@&quot;&quot;;</div><div class="line">    AFHTTPSessionManager *manager=[AFHTTPSessionManager manager];</div><div class="line">    manager.completionQueue=dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</div><div class="line">    AFHTTPResponseSerializer *responseSerializer=[AFHTTPResponseSerializer serializer];</div><div class="line">    manager.responseSerializer=responseSerializer;</div><div class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0); //创建信号量</div><div class="line">    [manager POST:urlStr parameters:params progress:nil success:^(NSURLSessionDataTask *task, id responseObject) &#123;</div><div class="line">        if (responseObject) &#123;</div><div class="line">            NSString *responseStr=[[NSString alloc] initWithData:responseObject encoding:NSUTF8StringEncoding];</div><div class="line">            resultStr=responseStr;</div><div class="line">        &#125;</div><div class="line">        dispatch_semaphore_signal(semaphore);//不管请求状态是什么，都得发送信号，否则会一直卡着进程</div><div class="line">    &#125; failure:^(NSURLSessionDataTask *task, NSError *error) &#123;</div><div class="line">        dispatch_semaphore_signal(semaphore);//不管请求状态是什么，都得发送信号，否则会一直卡着进程</div><div class="line">    &#125;];</div><div class="line">    dispatch_semaphore_wait(semaphore,DISPATCH_TIME_FOREVER);  //等待</div><div class="line">    return resultStr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/AFNetwork信号量转异步请求为同步请求引起死锁问题解决/" data-id="cjba9sv300000hhs6l7evkbwn" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-IOS之多重代理（转载）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/IOS之多重代理（转载）/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使用场景：UIScrollView的滑动位移的监听，一般是用UIScrollView的代理来实现的，但是有时候需要对一个UIScrollView在两个地方进行监听，那么很自然地就想到需要这两个地方都设置为UIScrollView的代理，不过UIScrollView的代理只能设置一个，有没有什么办法可以实现这一特别的需求呢，那就是利用Objective-C的消息转发机制实现的一个多重代理模型。<br>引用自<a href="http://www.cocoachina.com/ios/20151208/14595.html" target="_blank" rel="external">http://www.cocoachina.com/ios/20151208/14595.html</a></p>
<p>下面是原文：<br>在Objective-C中，经常使用delegate来在对象之间通信，但是delegate一般是对象间一对一的通信，有时候我们希望delegate方法由多个不同的对象来处理，比如UITableView继承于UIScrollView,我们希望他的delegate中UIScrollViewDelegate的方法由一个独立的类来处理，以便实现一些效果，比如像下图这样的头部图片滚动拉伸效果，只需要实现UIScrolViewDelegate的scrollViewDidScroll方法，这样做的好处是可以降低代码耦合度，将实现不同功能的方法封装在独立的delegate中，便于复用和维护管理。<br><strong>一、OC的消息机制</strong></p>
<p>那么，怎样实现delegate方法的动态转发呢？这需要用到Objective-C的消息机制，我们都知道，在OC中，调用一个对象的方法，实际上是给对象发了一条消息，在编译Objective－C函数调用的语法时，会被翻译成一个C的函数调用：objc_msgSend(),例如：</p>
<p><code>[array insertObject:foo atIndex:2];</code></p>
<p><code>//会被翻译成:</code></p>
<p><code>objc_msgSend(array, @selector(insertObject:atIndex), foo, 2);</code></p>
<p>那么，objc_msgSend又做了哪些事呢？，以[object foo]为例:</p>
<ol>
<li><p>通过object的isa指针找到它的class</p>
</li>
<li><p>在class的method_list中找到foo</p>
</li>
<li><p>如果class中没找到foo，则继续往他的superclass中查找</p>
</li>
<li><p>一旦找到foo这个函数，就去执行对应的方法实现(IMP)</p>
</li>
</ol>
<p>如果一直没有找到foo,OC的runtime将继续下面的步骤：</p>
<p><strong>二、动态方法决议与消息转发</strong></p>
<p>在Objective-C中，如果向一个对象发送一条该对象无法处理的消息(对应selector不存在)，会导致程序crash， 但是，在crash之前，oc的运行时系统会先经过以下两个步骤：</p>
<ol>
<li><p>Dynamic Method Resolution</p>
</li>
<li><p>Message Forwarding</p>
</li>
</ol>
<p>1、Dynamic Method Resolution（动态方法决议）</p>
<p>首先，如果调用的方法是实例方法，OC的运行时会调用－ (BOOL)resolveInstanceMethod:(SEL)sel，如果是类方法，则会调用+ (BOOL)resolveClassMethod:(SEL)sel 让我们可以在程序运行时动态的为一个selector提供实现,如果我们添加了函数的实现，并返回YES，运行时系统会重启一次消息的发送过程，调用动态添加的方法。例如,下面的例子：</p>
<p><code>+ (BOOL)resolveInstanceMethod:(SEL)sel{</code></p>
<p><code>if</code> <code>(sel == @selector(foo)) {</code></p>
<p><code>class_addMethod([self class], sel, (IMP)dynamicMethodIMP, ``&quot;V@:&quot;``);</code></p>
<p><code>return</code> <code>YES;</code></p>
<p><code>}</code></p>
<p><code>return</code> <code>[``super</code> <code>resolveInstanceMethod:sel];</code></p>
<p><code>}</code></p>
<p><code>void dynamicMethodIMP(id self, SEL _cmd){</code></p>
<p><code>NSLog(@``&quot;%s&quot;``, __PRETTY_FUNCTION__);</code></p>
<p><code>}</code></p>
<p>class_addMethod 方法动态的添加新的方法与对应的实现，如果调用了[Foo foo],将会转到动态添加的dynamicMethodIMP 方法中。Objective-C的方法本质上是一个至少包含两个参数(id self, SEL _cmd)的C函数，这样，当重启消息发送时，就能在类中找到@selector(foo)了。而如果方法返回NO时，将会进入下一步：消息转发(Message Forwarding)</p>
<p>2、Message Forwarding（消息转发）</p>
<p>消息转发分为两步：</p>
<ul>
<li><p>首先运行时系统会调用- (id)forwardingTargetForSelector:(SEL)aSelector方法，如果这个方法中返回的不是nil或者self，运行时系统将把消息发送给返回的那个对象</p>
</li>
<li><p>如果- (id)forwardingTargetForSelector:(SEL)aSelector返回的是nil或者self，运行时系统首先会调用- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector方法来获得方法签名，方法签名记录了方法的参数和返回值的信息，如果－methodSignatureForSelector 返回的是nil, 运行时系统会抛出unrecognized selector exception，程序到这里就结束了。</p>
</li>
</ul>
<p>整个流程可以用下面这张图表示</p>
<p>[图片上传失败…(image-fc3697-1511765955273)]</p>
<p> <strong>三、实现多重代理</strong> </p>
<p>结合上面的流程分析，我么可以发现，要实现多重代理的分发，我们需要让Runtime系统运行到forwardInvocation这一步，并在该方法中将delegate方法分发到其他各个对象中去：</p>
<p><code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector{</code></p>
<p><code>NSMethodSignature *signature = [``super</code> <code>methodSignatureForSelector:aSelector];</code></p>
<p><code>if</code> <code>(!signature) {</code></p>
<p><code>for</code> <code>(id target ``in</code> <code>self.allDelegates) {</code></p>
<p><code>if</code> <code>((signature = [target methodSignatureForSelector:aSelector])) {</code></p>
<p><code>break``;</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>return</code> <code>signature;</code></p>
<p><code>}</code></p>
<p><code>- (void)forwardInvocation:(NSInvocation *)anInvocation{</code></p>
<p><code>for</code> <code>(id target ``in</code> <code>self.allDelegates) {</code></p>
<p><code>if</code> <code>([target respondsToSelector:anInvocation.selector]) {</code></p>
<p><code>[anInvocation invokeWithTarget:target];</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p>由于我们调用delegate的方法时，一般会先调用[delegate responseToSelector]方法，所以，我们还需要实现这个方法：</p>
<p><code>- (BOOL)respondsToSelector:(SEL)aSelector{</code></p>
<p><code>if</code> <code>([``super</code> <code>respondsToSelector:aSelector]) {</code></p>
<p><code>return</code> <code>YES;</code></p>
<p><code>}</code></p>
<p><code>for</code> <code>(id target ``in</code> <code>self.allDelegates) {</code></p>
<p><code>if</code> <code>([target respondsToSelector:aSelector]) {</code></p>
<p><code>return</code> <code>YES;</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>return</code> <code>NO;</code></p>
<p><code>}</code></p>
<p><code>@end</code></p>
<p>然后我们来测试一下，新建一个ScrollDelegate类，实现UIScrollViewDelegate方法：</p>
<p><code>#import &quot;ScrollDelegate.h&quot;</code></p>
<p><code>@implementation ScrollDelegate</code></p>
<p><code>- (void)scrollViewDidScroll:(UIScrollView *)scrollView{</code></p>
<p><code>NSLog(@``&quot;%s&quot;``, __PRETTY_FUNCTION__);</code></p>
<p><code>}</code></p>
<p><code>@end</code></p>
<p>然后再新建一个ViewController，也实现UIScrollViewDelegate方法，添加一个UIScrollView在controller的view中，然后设置scrollView的delegate为multipleProxy：</p>
<p><code>#import &quot;ViewController.h&quot;</code></p>
<p><code>#import &quot;MultipleDelegate.h&quot;</code></p>
<p><code>#import &quot;ScrollDelegate.h&quot;</code></p>
<p><code>@interface ViewController ()@property (weak, nonatomic) IBOutlet UIScrollView *scrollView;</code></p>
<p><code>@end</code></p>
<p><code>@implementation ViewController{</code></p>
<p><code>MultipleDelegate *_multipleDelegate;</code></p>
<p><code>}</code></p>
<p><code>- (void)viewDidLoad {</code></p>
<p><code>[``super</code> <code>viewDidLoad];</code></p>
<p><code>self.scrollView.contentSize = CGSizeMake(self.view.bounds.size.width, self.view.bounds.size.height * 2);</code></p>
<p><code>_multipleDelegate = [MultipleDelegate ``new``];</code></p>
<p><code>//添加要处理delegate方法的对象</code></p>
<p><code>NSArray *array = @[self, [ScrollDelegate ``new``]];</code></p>
<p><code>_multipleDelegate.allDelegates = array;</code></p>
<p><code>self.scrollView.delegate = (id)_multipleDelegate;</code></p>
<p><code>}</code></p>
<p><code>- (void)scrollViewDidScroll:(UIScrollView *)scrollView{</code></p>
<p><code>NSLog(@``&quot;%s&quot;``, __PRETTY_FUNCTION__);</code></p>
<p><code>}</code></p>
<p><code>@end</code></p>
<p> |</p>
<p>运行，滑动scrollView，看看控制台打印的信息：</p>
<p><code>2015-11-01 11:07:49.199 MultipleDelegateDemo[4732:498520] -[ViewController scrollViewDidScroll:]</code></p>
<p><code>2015-11-01 11:07:49.200 MultipleDelegateDemo[4732:498520] -[ScrollDelegate scrollViewDidScroll:]</code></p>
<p><code>2015-11-01 11:07:49.227 MultipleDelegateDemo[4732:498520] -[ViewController scrollViewDidScroll:]</code></p>
<p><code>2015-11-01 11:07:49.227 MultipleDelegateDemo[4732:498520] -[ScrollDelegate scrollViewDidScroll:]</code></p>
<p> |</p>
<p>很好，deegate方法已经被正确地转发给了两个对象了，看起来好像没什么不对，可是，细心的你一定会发现，这里存在retain cycle：controller -&gt; _multipleDelegate -&gt; controller，那么怎样解决这个问题呢？</p>
<p><strong>四、NSPointerArray防止循环引用</strong></p>
<p>因为NSArray会对对象进行retain操作，导致循环引用的产生，所以我们可以用NSPointerArray来解决这个问题，但是需要注意对于其他的delegate对象也需要在controller中对其强引用， 最终MultipleDelegateProxy的实现：</p>
<p><code>#import &quot;KIZMultipleDelegateProxy.h&quot;</code></p>
<p><code>@interface KIZMultipleDelegateProxy ()</code></p>
<p><code>@property (nonatomic, strong) NSPointerArray *weakRefTargets;</code></p>
<p><code>@end</code></p>
<p><code>@implementation KIZMultipleDelegateProxy</code></p>
<p><code>- (void)setDelegateTargets:(NSArray *)delegateTargets{</code></p>
<p><code>self.weakRefTargets = [NSPointerArray weakObjectsPointerArray];</code></p>
<p><code>for</code> <code>(id delegate ``in</code> <code>delegateTargets) {</code></p>
<p><code>[self.weakRefTargets addPointer:(__bridge void *)delegate];</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>- (BOOL)respondsToSelector:(SEL)aSelector{</code></p>
<p><code>if</code> <code>([``super</code> <code>respondsToSelector:aSelector]) {</code></p>
<p><code>return</code> <code>YES;</code></p>
<p><code>}</code></p>
<p><code>for</code> <code>(id target ``in</code> <code>self.weakRefTargets) {</code></p>
<p><code>if</code> <code>([target respondsToSelector:aSelector]) {</code></p>
<p><code>return</code> <code>YES;</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>return</code> <code>NO;</code></p>
<p><code>}</code></p>
<p><code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector{</code></p>
<p><code>NSMethodSignature *sig = [``super</code> <code>methodSignatureForSelector:aSelector];</code></p>
<p><code>if</code> <code>(!sig) {</code></p>
<p><code>for</code> <code>(id target ``in</code> <code>self.weakRefTargets) {</code></p>
<p><code>if</code> <code>((sig = [target methodSignatureForSelector:aSelector])) {</code></p>
<p><code>break``;</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>return</code> <code>sig;</code></p>
<p><code>}</code></p>
<p><code>//转发方法调用给所有delegate</code></p>
<p><code>- (void)forwardInvocation:(NSInvocation *)anInvocation{</code></p>
<p><code>for</code> <code>(id target ``in</code> <code>self.weakRefTargets) {</code></p>
<p><code>if</code> <code>([target respondsToSelector:anInvocation.selector]) {</code></p>
<p><code>[anInvocation invokeWithTarget:target];</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>@end</code></p>
<p><strong>五、小记</strong></p>
<p>利用这个多重代理动态转发，我封装了一些独立的delegate实现的小功能，比如本文开头提到的TableView头部图片拉伸效果，放在github上：<a href="https://github.com/zziking/KIZBehavior" target="_blank" rel="external">https://github.com/zziking/KIZBehavior</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/IOS之多重代理（转载）/" data-id="cjba9sv360002hhs6k87ob21z" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-IOS判断应用是否在新版本下第一次调用某方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/IOS判断应用是否在新版本下第一次调用某方法/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>  使用场景：判断应用在某一个app版本下是否第一次调用本函数，可以帮助实现某些需要app更新版本后执行一次的操作，比如清空沙盒目录。其实就是用NSUserDefaults来存储一个标记变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+(BOOL)isFirstLaunch&#123;</div><div class="line">    static int cachedResult=-1;</div><div class="line">    if (cachedResult!=-1) &#123;</div><div class="line">        return cachedResult;</div><div class="line">    &#125;</div><div class="line">    NSString *appVersionKey=[NSString stringWithFormat:@&quot;APP_VERSION_%@&quot;,[NSString getAppVersionString]];</div><div class="line">    BOOL appVersionValue=[UserDefaultTool getBoolForKey:appVersionKey defaultValue:NO];</div><div class="line">    cachedResult=!appVersionValue;</div><div class="line">    [UserDefaultTool setBool:YES forKey:appVersionKey];</div><div class="line">    return cachedResult;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/IOS判断应用是否在新版本下第一次调用某方法/" data-id="cjba9sv370003hhs6ypeibpu0" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-IOS审核之不支持IPV6" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/IOS审核之不支持IPV6/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/IOS审核之不支持IPV6/" data-id="cjba9sv380004hhs6nfka21mk" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-IOS应用模块化开发之路" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/IOS应用模块化开发之路/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/IOS应用模块化开发之路/" data-id="cjba9sv390005hhs6z9lg2wty" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-IOS推送集成" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/IOS推送集成/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="客户端集成极光推送"><a href="#客户端集成极光推送" class="headerlink" title="客户端集成极光推送"></a>客户端集成极光推送</h3><p>客户端直接集成极光推送最新SDK即可</p>
<h3 id="极光web平台端测试推送可达性"><a href="#极光web平台端测试推送可达性" class="headerlink" title="极光web平台端测试推送可达性"></a>极光web平台端测试推送可达性</h3><p>在极光推送后台web控制台页面可以直接对客户端进行推送消息测试，可以在客户端集成完毕后用这个服务来对集成的效果进行检验<br><img src="http://upload-images.jianshu.io/upload_images/2604347-2fea1f54dc58d883.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="jiguangweb.jpg"></p>
<h3 id="服务端集成极光推送"><a href="#服务端集成极光推送" class="headerlink" title="服务端集成极光推送"></a>服务端集成极光推送</h3><p>服务端集成极光推送可以采用两种方案，一是使用极光推送提供的服务端集成SDK，二是直接在服务端调用极光推送提供的HTTP接口发送HTTP请求。相比较而言，方案二具有集成工作量小，且对服务端的实现语言兼容性更好的优点，因此推荐使用HTTP接口来进行。下面给出一个示例实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line">package cn.com.jzj.pub.pubpush.service.impl;</div><div class="line"></div><div class="line">import cn.com.jzj.base.bean.ResultInfo;</div><div class="line">import cn.com.jzj.pub.pubpush.service.PubPushManager;</div><div class="line">import cn.com.jzj.pubbase.constant.PubCityConfigNameConst;</div><div class="line">import cn.com.jzj.pubbase.tools.PubCitySysConfigUtils;</div><div class="line">import org.apache.log4j.Logger;</div><div class="line">import org.springframework.stereotype.Service;</div><div class="line"></div><div class="line">import java.io.*;</div><div class="line">import java.net.HttpURLConnection;</div><div class="line">import java.net.URL;</div><div class="line"></div><div class="line"></div><div class="line">@Service</div><div class="line">public class PubPushManagerImpl implements PubPushManager&#123;</div><div class="line">	</div><div class="line">	private static final Logger Log = Logger.getLogger(PubPushManagerImpl.class);</div><div class="line">	/**</div><div class="line">	 * @Author jzj</div><div class="line">	 * @Date 2017/11/15 15:14</div><div class="line">	 * phoneNum 接受者的电话，作为推送的别名</div><div class="line">	 * message 消息内容</div><div class="line">	 * typeID 自定义消息类型，用于业务</div><div class="line">	 */</div><div class="line">	@Override</div><div class="line">	public ResultInfo sendMessage(String phoneNum, String message, int typeID)&#123;</div><div class="line">		ResultInfo resultInfo=new ResultInfo();</div><div class="line">		String pushServerURL=&quot;https://api.jpush.cn/v3/push&quot;;</div><div class="line">		//其中 base64_auth_string 的生成算法为：base64(appKey:masterSecret)即，对 appKey 加上冒号，加上 masterSecret 拼装起来的字符串，再做 base64 转换</div><div class="line">		//appKey:bc662af3dd133fb25fd02b3a</div><div class="line">		//masterSecret:d6ae162a258fd53bec5e1df0</div><div class="line">		//base64_auth_string:YmM2NjJhZjNkZDEzM2ZiMjVmZDAyYjNhOmQ2YWUxNjJhMjU4ZmQ1M2JlYzVlMWRmMA==</div><div class="line">		String defaultAuthorization=&quot;YmM2NjJhZjNkZDEzM2ZiMjVmZDAyYjNhOmQ2YWUxNjJhMjU4ZmQ1M2JlYzVlMWRmMA==&quot;;</div><div class="line">		String authorizationValue= PubCitySysConfigUtils.getSysConfigStrValue(PubCityConfigNameConst.PUB_SYS_CONFIG_JPUSH_AUTHORIZATION,defaultAuthorization);</div><div class="line">		PrintWriter out = null;</div><div class="line">		BufferedReader in = null;</div><div class="line">		String result = &quot;&quot;;</div><div class="line">		try &#123;</div><div class="line">			URL url = new URL(pushServerURL);</div><div class="line">			HttpURLConnection conn = (HttpURLConnection) url.openConnection();</div><div class="line">			conn.setDoOutput(true);    // 可以发送数据</div><div class="line">			conn.setDoInput(true);    // 可以接收数据</div><div class="line">			conn.setRequestMethod(&quot;POST&quot;);    // POST方法</div><div class="line">			// 必须注意此处需要设置UserAgent，否则google会返回403</div><div class="line">			conn.setRequestProperty</div><div class="line">					(&quot;User-Agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)&quot;);</div><div class="line">			conn.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</div><div class="line">			conn.setRequestProperty(&quot;Accept-Charset&quot;, &quot;UTF-8&quot;);</div><div class="line">			conn.setRequestProperty(&quot;Authorization&quot;,&quot;Basic &quot;+authorizationValue);</div><div class="line">			conn.connect();</div><div class="line">			// 写入的POST数据</div><div class="line">			OutputStreamWriter osw = new OutputStreamWriter(conn.getOutputStream(), &quot;UTF-8&quot;);</div><div class="line">			String generatedPostString=generatePostBodyString(phoneNum,message,typeID);</div><div class="line">			osw.write(generatedPostString);</div><div class="line">			osw.flush();</div><div class="line">			osw.close();</div><div class="line">			int responseCode=conn.getResponseCode();</div><div class="line">			Log.info(&quot;Invoke jpush api responseCode:&quot;+responseCode+&quot; responseMessage:&quot;+conn.getResponseMessage());</div><div class="line">			InputStream inputStream;</div><div class="line">			if (responseCode==HttpURLConnection.HTTP_OK||responseCode==HttpURLConnection.HTTP_ACCEPTED||responseCode==HttpURLConnection.HTTP_CREATED)&#123;</div><div class="line">				inputStream=conn.getInputStream();</div><div class="line">			&#125;else&#123;</div><div class="line">				inputStream=conn.getErrorStream();</div><div class="line">			&#125;</div><div class="line">			// 读取响应数据</div><div class="line">			in = new BufferedReader(</div><div class="line">					new InputStreamReader(inputStream,&quot;UTF-8&quot;));</div><div class="line">			String line;</div><div class="line">			while ((line = in.readLine()) != null) &#123;</div><div class="line">				result += line;</div><div class="line">			&#125;</div><div class="line">			resultInfo.setSuccess(true);</div><div class="line">			resultInfo.setCode(0);</div><div class="line">			resultInfo.setMessage(result);</div><div class="line">			Log.info(&quot;result:&quot;+result);</div><div class="line">		&#125; catch (Exception e) &#123;</div><div class="line">			resultInfo.setSuccess(false);</div><div class="line">			resultInfo.setCode(-1);</div><div class="line">			resultInfo.setMessage(&quot;发送 POST 请求出现异常！&quot;);</div><div class="line">			System.out.println(&quot;发送 POST 请求出现异常！&quot;+e);</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;finally&#123;</div><div class="line">			try&#123;</div><div class="line">				if(out!=null)&#123;</div><div class="line">					out.close();</div><div class="line">				&#125;</div><div class="line">				if(in!=null)&#123;</div><div class="line">					in.close();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			catch(IOException ex)&#123;</div><div class="line">				ex.printStackTrace();</div><div class="line">			&#125;finally &#123;</div><div class="line">				return resultInfo;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * @Author jzj</div><div class="line">	 * @Date 2017/11/15 15:10</div><div class="line">	 * 生成极光推送需要的post body内容</div><div class="line">	 * 注意apns_production参数，正式环境下（是指IOS客户端是否是调试环境）需要指定为true</div><div class="line">	 * &#123;</div><div class="line">	&quot;platform&quot;: &quot;all&quot;,</div><div class="line">	&quot;audience&quot;: &#123;</div><div class="line">	&quot;alias&quot;: [</div><div class="line">	&quot;13399990550&quot;</div><div class="line">	]</div><div class="line">	&#125;,</div><div class="line">	&quot;notification&quot; : &#123;</div><div class="line">	&quot;alert&quot; : &quot;Hi, JPusho!&quot;,</div><div class="line">	&quot;android&quot; : &#123;&#125;,</div><div class="line">	&quot;ios&quot; : &#123;</div><div class="line">	&quot;extras&quot; : &#123; &quot;typeid&quot; : 321&#125;</div><div class="line">	&#125;</div><div class="line">	&#125;,</div><div class="line">	&quot;options&quot;: &#123;</div><div class="line">	&quot;apns_production&quot;: false</div><div class="line">	&#125;</div><div class="line">	&#125;</div><div class="line">	 */</div><div class="line">	private String generatePostBodyString(String phoneNum,String message,int typeID)&#123;</div><div class="line">		return &quot;&#123;\&quot;platform\&quot;:\&quot;all\&quot;,\&quot;audience\&quot;:&#123;\&quot;alias\&quot;:[\&quot;&quot;+phoneNum+&quot;\&quot;]&#125;,\&quot;notification\&quot;:&#123;\&quot;alert\&quot;:\&quot;&quot;+message+&quot;\&quot;,\&quot;android\&quot;:&#123;&#125;,\&quot;ios\&quot;:&#123;\&quot;extras\&quot;:&#123;\&quot;typeid\&quot;:&quot;+typeID+&quot;&#125;&#125;&#125;,\&quot;options\&quot;:&#123;\&quot;apns_production\&quot;:true&#125;&#125;&quot;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/IOS推送集成/" data-id="cjba9sv3h0006hhs6a0i807cs" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-JZJModule注册器协议" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/JZJModule注册器协议/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一个模块主要包含两个方面的信息，一个是属性，一个是方法。其中，属性就是类似名称、图片、URL等信息；而方法主要就是指模块被点击后触发的事件。注册器的职责就是为模块填充这两方面的信息。为了在工程中能灵活地对模块信息进行管理，模块信息的注册信息管理采用了“一个中心，多地注册”的方式来进行。所谓的“一个中心”是指存在一个注册中心，负责统筹模块信息注册相关的事宜；而“多地注册”是指可以存在多个注册器，来添加模块注册信息。为了便于管理，我们约定注册器需要在自身的<code>+(void)load;</code>函数中将自身加入到注册中心中，这样我们就不必手动告诉注册中心工程中存在哪些注册器了。不同模块之间是以“type”属性作为唯一标识的，而不同注册器之间互相是没有感知的，也就是说注册器A在给一个“type”例如“type1”添加注册信息的同时，注册器B可能也在给“type1”添加注册信息，这就涉及到注册信息的冲突问题。冲突也分两个方面，属性的冲突和方法的冲突。属性的冲突是必然的，因为“type1”对应的名称不可能既是“name1”，又是“name2”，因此我们要求注册器提供一个优先级排序码，若两个注册器对同一“type”指定了属性信息，优先级高的注册器可以覆盖优先级低的注册器中的属性信息。方法的冲突则不是必然的，如果两个注册器都为“type1”指定了点击事件，那么我们可以认为最终只能执行其中一个注册器中的方法（优先级高的那个），也可以认为两个方法都可以执行（按照优先级先后执行），因此我们要求注册器还需要提供下面的信息：方法是否排他以及是否响应某模块。方法是否排他可以决定方法冲突时，是只执行优先级高的那个，还是按照优先级先后执行。是否响应某模块可以方便模块在被点击时筛选出可以响应自己的注册器。<br>因此，在模块被点击的时候，会执行下面的逻辑：</p>
<ol>
<li>从所有具有事件排他性的注册器中找到可以响应此模块点击事件的注册器，然后取出其中优先级最高的那一个来执行；</li>
<li>找到所有不具有事件排他性的注册器，然后按照优先级顺序依次执行；</li>
<li>执行外部绑定的其他执行事件；</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/JZJModule注册器协议/" data-id="cjba9sv3i0007hhs6czcld9pj" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-AnyChat之UDP协议" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/AnyChat之UDP协议/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/AnyChat之UDP协议/" data-id="cjba9sv340001hhs6o97yzzzn" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-JZJModule接入指南" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/17/JZJModule接入指南/" class="article-date">
  <time datetime="2017-12-17T04:00:08.000Z" itemprop="datePublished">2017-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-将JZJModule库引入工程"><a href="#1-将JZJModule库引入工程" class="headerlink" title="1.将JZJModule库引入工程"></a>1.将JZJModule库引入工程</h3><h5 id="源码形式"><a href="#源码形式" class="headerlink" title="源码形式"></a>源码形式</h5><p>直接将源码形式的JZJModule库加入工程中，则工程中使用到JZJModule功能的地方加上<code>#import &quot;JZJModule.h&quot;</code>即可</p>
<h5 id="framework形式"><a href="#framework形式" class="headerlink" title="framework形式"></a>framework形式</h5><p>通过静态库framework的方式加入工程中，则工程中使用到JZJModule功能的地方加上<code>#import &lt;JZJModule/JZJModule.h&gt;</code>即可</p>
<h3 id="2-定义自己的模块注册器"><a href="#2-定义自己的模块注册器" class="headerlink" title="2.定义自己的模块注册器"></a>2.定义自己的模块注册器</h3><p>模块注册器需要自己在工程中新建，下面给出一个示例<br><code>Register1.h</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &quot;JZJModule.h&quot;</div><div class="line"></div><div class="line"></div><div class="line">@interface Registerer1 : NSObject&lt;JZJModuleRegisterProtocol&gt;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p><code>Register1.m</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">#import &quot;Registerer1.h&quot;</div><div class="line">#import &quot;UIAlertView+Blocks.h&quot;</div><div class="line">#import &quot;Routable.h&quot;</div><div class="line">#import &quot;NSObject+GetObjFromJsonFile.h&quot;</div><div class="line"></div><div class="line">static NSMutableDictionary* blockTable=nil;</div><div class="line"></div><div class="line"></div><div class="line">@implementation Registerer1 &#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">+(void)load &#123;</div><div class="line">    [[JZJModuleRegisterCenter sharedCenter] addRegisterer:self.class];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(NSMutableDictionary *)getBlockTable&#123;</div><div class="line">    if(blockTable==nil)&#123;</div><div class="line">        blockTable=@&#123;&#125;.mutableCopy;</div><div class="line">    &#125;</div><div class="line">    return blockTable;</div><div class="line">&#125;</div><div class="line">+(void)registerType:(NSString*)type withBlock:(BOClickInTableBlock)block&#123;</div><div class="line">    NSMutableDictionary *info= [self getBlockTable];</div><div class="line">    if (info) &#123;</div><div class="line">        [info setObject:block forKey:type];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">+(void)registerTypes:(NSArray*)typeArray withBlock:(BOClickInTableBlock)block&#123;</div><div class="line">    for (NSString *type in typeArray) &#123;</div><div class="line">        [self registerType:type withBlock:block];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(void)register &#123;</div><div class="line">    [self registerInformation];</div><div class="line">    [self registerEvent];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(BOOL)responseClick:(JZJModuleBO *)moduleBO &#123;</div><div class="line">    BOOL result=NO;</div><div class="line">    if(moduleBO.moduleType==1)&#123;</div><div class="line">        result=YES;</div><div class="line">    &#125; else if(moduleBO.moduleType==2)&#123;</div><div class="line">        result=YES;</div><div class="line">    &#125;else&#123;</div><div class="line">        BOClickInTableBlock clickInTableBlock=[self getBlockTable][moduleBO.type];</div><div class="line">        if(clickInTableBlock)&#123;</div><div class="line">            result=YES;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(void)onClick:(JZJModuleBO *)moduleBO &#123;</div><div class="line">    if(moduleBO.moduleType==1)&#123;</div><div class="line">        [[UIApplication sharedApplication] openURL:[[NSURL alloc] initWithString:moduleBO.url] options:nil completionHandler:nil];</div><div class="line">    &#125; else if(moduleBO.moduleType==2)&#123;</div><div class="line">        [[Routable sharedRouter] open:moduleBO.url];</div><div class="line">    &#125;else&#123;</div><div class="line">        BOClickInTableBlock clickInTableBlock=[self getBlockTable][moduleBO.type];</div><div class="line">        if(clickInTableBlock)&#123;</div><div class="line">            clickInTableBlock(moduleBO);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(void)registerInformation &#123;</div><div class="line">    NSMutableArray *files=[NSMutableArray array];</div><div class="line">    [files addObject:[[[NSBundle mainBundle] bundlePath] stringByAppendingPathComponent:@&quot;JZJModule.json&quot;]];</div><div class="line">    for (int i=0; i&lt;files.count; i++) &#123;</div><div class="line">        NSString *filepath=files[i];</div><div class="line">        id jsonObject=[NSObject fromJsonFile:filepath];</div><div class="line">        if (jsonObject!=nil) &#123;</div><div class="line">            NSArray *jsonArray=jsonObject;</div><div class="line">            for (NSDictionary *info in jsonArray) &#123;</div><div class="line">                [JZJModuleBO registerType:info[@&quot;type&quot;] withInfomationDic:info];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">+(void)registerEvent &#123;</div><div class="line"></div><div class="line">    [self registerType:@&quot;type3&quot; withBlock:^(JZJModuleBO *bo) &#123;</div><div class="line">        [UIAlertView alertTitle:bo.name message:bo.desc];</div><div class="line">    &#125;];</div><div class="line">    [self registerTypes:@[@&quot;type5&quot;,@&quot;type6&quot;] withBlock:^(JZJModuleBO *bo) &#123;</div><div class="line">        NSMutableDictionary *params=@&#123;&#125;.mutableCopy;</div><div class="line">        params[@&quot;navTitle&quot;]=bo.name;</div><div class="line">        params[@&quot;content&quot;]=bo.desc;</div><div class="line">        [[Routable sharedRouter] open:@&quot;BlankTextVC&quot; animated:YES extraParams:params];</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>在这个示例注册器中，注册器从资源文件<code>JZJModule.json</code>文件中读取json字符串转成的字典，然后根据字典向模块注册中心注册新模块的基本注册信息，然后在<code>registerEvent</code>函数中指定模块对应的点击事件。当中使用了<code>Routable</code>的路由框架做页面跳转，详见<a href="https://github.com/clayallsopp/routable-ios" target="_blank" rel="external">https://github.com/clayallsopp/routable-ios</a>。下面给出<code>JZJModule.json</code>的内容<br><code>JZJModule.json</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">[&#123;</div><div class="line">	&quot;type&quot;: &quot;type1&quot;,</div><div class="line">	&quot;name&quot;: &quot;VC1&quot;,</div><div class="line">	&quot;img&quot;: &quot;img1&quot;,</div><div class="line">	&quot;moduleType&quot;: &quot;2&quot;,</div><div class="line">	&quot;url&quot;: &quot;VC1&quot;,</div><div class="line">	&quot;desc&quot;:&quot;VC1&quot;</div><div class="line">&#125;, &#123;</div><div class="line">	&quot;type&quot;: &quot;type2&quot;,</div><div class="line">	&quot;name&quot;: &quot;VC2&quot;,</div><div class="line">	&quot;img&quot;: &quot;img2&quot;,</div><div class="line">	&quot;moduleType&quot;: &quot;2&quot;,</div><div class="line">	&quot;url&quot;: &quot;VC2&quot;,</div><div class="line">	&quot;desc&quot;:&quot;VC2&quot;</div><div class="line">&#125;, &#123;</div><div class="line">	&quot;type&quot;: &quot;type3&quot;,</div><div class="line">	&quot;name&quot;: &quot;提示3&quot;,</div><div class="line">	&quot;img&quot;: &quot;img3&quot;,</div><div class="line">	&quot;desc&quot;:&quot;提示消息3&quot;</div><div class="line">&#125;, &#123;</div><div class="line">	&quot;type&quot;: &quot;type4&quot;,</div><div class="line">	&quot;name&quot;: &quot;提示4&quot;,</div><div class="line">	&quot;img&quot;: &quot;img4&quot;,</div><div class="line">	&quot;desc&quot;:&quot;提示消息4&quot;</div><div class="line">&#125;, &#123;</div><div class="line">	&quot;type&quot;: &quot;type5&quot;,</div><div class="line">	&quot;name&quot;: &quot;望庐山瀑布&quot;,</div><div class="line">	&quot;img&quot;: &quot;img5&quot;,</div><div class="line">	&quot;desc&quot;:&quot;日照香炉生紫烟，遥看瀑布挂前川。&quot;</div><div class="line">&#125;, &#123;</div><div class="line">	&quot;type&quot;: &quot;type6&quot;,</div><div class="line">	&quot;name&quot;: &quot;春晓&quot;,</div><div class="line">	&quot;img&quot;: &quot;img6&quot;,</div><div class="line">	&quot;desc&quot;:&quot;春眠不觉晓，处处闻啼鸟。&quot;</div><div class="line">&#125;, &#123;</div><div class="line">	&quot;type&quot;: &quot;type7&quot;,</div><div class="line">	&quot;name&quot;: &quot;打log&quot;,</div><div class="line">	&quot;img&quot;: &quot;img7&quot;,</div><div class="line">	&quot;desc&quot;: &quot;操作操作&quot;</div><div class="line">&#125;, &#123;</div><div class="line">	&quot;type&quot;: &quot;type8&quot;,</div><div class="line">	&quot;name&quot;: &quot;去网页&quot;,</div><div class="line">	&quot;img&quot;: &quot;img8&quot;,</div><div class="line">	&quot;moduleType&quot;: &quot;1&quot;,</div><div class="line">	&quot;url&quot;: &quot;http://www.baidu.com&quot;,</div><div class="line">	&quot;desc&quot;:&quot;http://www.baidu.com&quot;</div><div class="line">&#125;]</div></pre></td></tr></table></figure></p>
<h3 id="3-在页面中使用模块信息"><a href="#3-在页面中使用模块信息" class="headerlink" title="3.在页面中使用模块信息"></a>3.在页面中使用模块信息</h3><p>页面中一般使用<code>UITableView</code>或者<code>UICollectionView</code>来装载模块对应的信息，下面给出一个<code>UITableView</code>页面的示例<br><code>TableVC.h</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &quot;JZJModule.h&quot;</div><div class="line"></div><div class="line"></div><div class="line">@interface TableVC : UIViewController</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p><code>TableVC.m</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">#import &quot;TableVC.h&quot;</div><div class="line">#import &quot;Masonry.h&quot;</div><div class="line"></div><div class="line">static NSString * const cellReuse = @&quot;cellID&quot;;</div><div class="line"></div><div class="line">@interface TableVC()&lt;UITableViewDataSource,UITableViewDelegate&gt;</div><div class="line">@property (nonatomic, strong) UITableView *tableView;</div><div class="line">@property (nonatomic, strong) NSMutableArray *mCollectionItems;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation TableVC &#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line">-(void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    [self initData];</div><div class="line">    [self initView];</div><div class="line">    [self fetchCollectionItems];</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(void)initView &#123;</div><div class="line">    [super initView];</div><div class="line">    _tableView=[UITableView new];</div><div class="line">    _tableView.dataSource=self;</div><div class="line">    _tableView.delegate=self;</div><div class="line">    [self.view addSubview:_tableView];</div><div class="line">    [_tableView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.edges.mas_equalTo(self.view);</div><div class="line">    &#125;];</div><div class="line">    [_tableView registerClass:JZJModuleTVCell.class forCellReuseIdentifier:cellReuse];</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(void)initData&#123;</div><div class="line">    self.mCollectionItems=[NSMutableArray array];</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(void)fetchCollectionItems &#123;</div><div class="line">    [self.mCollectionItems removeAllObjects];</div><div class="line">    NSArray *types=@[@&quot;type1&quot;,@&quot;type2&quot;,@&quot;type3&quot;,@&quot;type4&quot;,@&quot;type5&quot;,@&quot;type6&quot;,@&quot;type7&quot;,@&quot;type8&quot;];</div><div class="line">    for(int i=0;i&lt;types.count;i++)&#123;</div><div class="line">        JZJModuleBO *moduleBO=[JZJModuleBO instanceWithType:types[i]];</div><div class="line">        [self.mCollectionItems addObject:moduleBO];</div><div class="line">    &#125;</div><div class="line">    [self.tableView reloadData];</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section&#123;</div><div class="line">    return self.mCollectionItems.count;</div><div class="line">&#125;</div><div class="line">-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath &#123;</div><div class="line">    return 44;</div><div class="line">&#125;</div><div class="line">-(UITableViewCell*)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath&#123;</div><div class="line">    JZJModuleTVCell *cell = [tableView dequeueReusableCellWithIdentifier:cellReuse forIndexPath:indexPath];</div><div class="line">    JZJModuleBO *item=self.mCollectionItems[indexPath.row];</div><div class="line">    [cell configureWithBO:item];</div><div class="line">    return cell;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p> 其中，<code>JZJModuleTVCell</code>是一种根据JZJModule的模块信息来适配的<code>UITableViewCell</code>，项目中也可以自定义。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/17/JZJModule接入指南/" data-id="cjba9sv3k0009hhs6ondifwoo" class="article-share-link">Delen</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/12/17/MBA外接显示器后关闭自带显示器/">(no title)</a>
          </li>
        
          <li>
            <a href="/2017/12/17/AFNetwork信号量转异步请求为同步请求引起死锁问题解决/">(no title)</a>
          </li>
        
          <li>
            <a href="/2017/12/17/IOS之多重代理（转载）/">(no title)</a>
          </li>
        
          <li>
            <a href="/2017/12/17/IOS判断应用是否在新版本下第一次调用某方法/">(no title)</a>
          </li>
        
          <li>
            <a href="/2017/12/17/IOS审核之不支持IPV6/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Jiang Zijie<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>